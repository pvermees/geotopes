\begin{refsection}

\chapter{Extending \texttt{IsoplotR}}\label{ch:extending-IsoplotR}

\texttt{IsoplotR} aims to cover the most commonly used functions in
geochronology. However geochronology is such a diverse and rapidly
evolving field of science, that it is impossible for one piece of
software to cover everything. This is why, from its inception,
\texttt{IsoplotR} was designed with extendability in
mind. Section~\ref{sec:API} gives an overview of the code base for the
CLI, which can be used as building blocks for automation scripts,
alternative visualisations and new
applications. Section~\ref{sec:schema} summarises the \texttt{.json}
schema that is used to import and export data to the GUI. Using this
schema, it is possible to connect lower level data reduction software
(written in any programming language) to \texttt{IsoplotRgui}.

\section{List of functions}\label{sec:API}

This Section gives a brief summary of \texttt{IsoplotR}'s Application
Programming Interface (API). This is a list of all \texttt{IsoplotR}'s
public functions. To view this list within \texttt{R}, enter:

\begin{console}
help(package='IsoplotR')
\end{console}

\noindent at the CLI. The number of public functions was intentionally
kept small, so as to shorten the learning curve. However despite this
apparent simplicity, \texttt{IsoplotR}'s code base offers a lot of
flexibility. This is because:

\begin{enumerate}
\item several functions serve multiple purposes. For example, the
  \texttt{settings()} function can be used to get or set decay
  constants, isotopic ratios and other global parameters, and the
  \texttt{peakfit()} function groups methods to compute finite
  mixtures as well as minimum age models.
\item \texttt{IsoplotR} is built around 13 so-called S3 classes,
  which are used to store different types of chronometric data. For
  example, a single function called \texttt{age()} can be used to
  calculate U--Pb, Th--Pb, Pb--Pb, Ar--Ar, Rb--Sr, Sm--Nd, Lu--Hf,
  Re--Os, fission track, U--Th--He or Th--U data, both from datasets
  of multiple aliquots, or for individual measurements.
\item some functions can be used to both compute and plot data.  For
  example, the \texttt{kde()} function generates kernel density plots,
  whilst returning the plot coordinates and optimal bandwidth to the
  user. It is possible to suppress the graphical output but retain the
  numerical output. Thus, the \texttt{kde()} function can be used to
  write one's own visualisation. The same is true for the
  \texttt{isochron()} and \texttt{weightedmean()} functions.
\item \texttt{IsoplotR} is entirely written in \texttt{R} and does not
  depend on any non-standard packages. This makes the package small
  and easy to install. Which means that, if your \texttt{R} code
  requires uses one of \texttt{IsoplotR}'s functions, then this won't
  bloat your program. It also means that it is relatively
  straightforward to lift functions out of \texttt{IsoplotR} and copy
  them into another program. You have the permission to do so as long
  as the origin of the code is documented in the new program, and your
  program is released under the GPL-3 license, like \texttt{IsoplotR}
  itself.
\end{enumerate}

Detailed documentation can be obtained from within \texttt{R}, using
the \texttt{help} or \texttt{?} functions. For example, to view
the documentation of the \texttt{isochron()} function, type

\begin{console}
?isochron
\end{console}

\noindent at the command prompt. The detailed documentation covers
well over 100 pages and will not be reproduced here. Instead we
suffice with a simple list of the functions accompanied by a brief
summary of their input and output:

\begin{longtable}{@{}p{.25\linewidth}@{}p{.75\linewidth}@{}}
function & description \\ \hline

\texttt{age} & Calculates U--Pb, Pb--Pb, Th--Pb, Ar--Ar, K--Ca,
Re--Os, Sm--Nd, Rb--Sr, Lu--Hf, U--Th--He, Th--U and fission track
ages their analytical uncertainties, either from a data object
returned by the \texttt{read.data} function, or from a simple vector
of isotopic ratios. \\

\texttt{age2ratio} & Predict
\textsuperscript{207}Pb/\textsuperscript{235}U,
\textsuperscript{238}U/\textsuperscript{206}Pb,
\textsuperscript{207}Pb/\textsuperscript{206}Pb,
\textsuperscript{208}Pb/\textsuperscript{232}Th,
\textsuperscript{40}Ar/\textsuperscript{39}Ar,
\textsuperscript{40}Ca/\textsuperscript{40}K,
\textsuperscript{176}Hf/\textsuperscript{176}Lu,
\textsuperscript{87}Sr/\textsuperscript{87}Rb,
\textsuperscript{187}Os/\textsuperscript{187}Re,
\textsuperscript{143}Nd/\textsuperscript{147}Sm ratios and
uncertainties for one or more ages and their uncertainties; or the
Wetherill, Tera-Wasserburg or U--Th--Pb concordia ratios and
covariance matrix of a single age and its uncertainty; or the
Stacey-Kramers composition of a given age.\\

\texttt{agespectrum} & Plot a
(\textsuperscript{40}Ar/\textsuperscript{39}Ar) release spectrum and
returns the plateau age if so requested.\\

\texttt{cad} & Plot geochronological data as cumulative age
distributions.\\

\texttt{central} & Calculate fission track and U--Th--He central ages
and compositions using the methods discussed in
Sections~\ref{sec:mixtures} and Equation~\ref{eq:central} or
\ref{sec:UThHeCompositional}, respectively.\\

\texttt{classes} & Description of the S3 classes \texttt{UPb},
\texttt{PbPb}, \texttt{ThPb}, \texttt{KCa}, \texttt{UThHe},
\texttt{fissiontracks}, \texttt{detritals} and \texttt{PD}, where the
latter is the parent class of the simple parent-daughter chronometers
\texttt{RbSr}, \texttt{SmNd}, \texttt{LuHf} and \texttt{ReOs}. All
these classes have overloaded versions of the generic
\texttt{length()} function and square bracket subsetting method.\\

\texttt{concordia} & Plots U--Pb data on Wetherill, Tera-Wasserburg or
U--Th--Pb concordia diagrams, calculates concordia ages and
compositions or discordia ages if so requested.\\

\texttt{data2york} & Helper function for the \texttt{york}
function. Takes geochronological data as input and produces a
five-column table with the variables, their uncertainties and error
correlations as output. These can subsequently be used for
\citet{york2004} regression.\\

\texttt{discfilter} & Set up one of the six U--Pb discordance filters
defined by \citet{vermeesch2021} and specify the cutoff limits.\\

\texttt{diseq} & Specify any (initial or measured) disequilibrium
between $^{238}$U, $^{234}$U, $^{230}$Th, and $^{226}$Ra; or between
$^{235}$U and $^{231}$Pa. This function returns and object of class
\texttt{diseq}, which can be used as optional input to any function
that accepts U--Pb data as input.\\

\texttt{ellipse} & Helper function for the \texttt{scatterplot}
function. Constructs an error ellipse at a given confidence level from
its centre and covariance matrix. \\

\texttt{evolution} & Plots Th--U data on a
$^{234}$U/$^{238}$U--$^{230}$Th/$^{238}$U evolution diagram, a
$^{234}$U/$^{238}$U-age diagram, or (if $^{234}$U/$^{238}$U is assumed
to be in secular equilibrium), a
$^{230}$Th/$^{232}$Th-$^{238}$U/$^{232}$Th diagram; calculates
isochron ages.\\

\texttt{examples} & An 18-item list containing U--Pb, Pb--Pb, Ar--Ar,
K--Ca, Re--Os, Sm--Nd, Rb--Sr, Lu--Hf, U--Th--He, Th--U, fission track
and detrital datasets that are used to test and illustrate
\texttt{IsoplotR}'s functions in the built-in documentation.\\

\texttt{helioplot} & Plot U--Th(--Sm)--He data on a (log[He/Th]
vs. log[U/He]) logratio plot or U--Th--He ternary diagram.\\

\texttt{isochron} & Plots cogenetic Ar--Ar, K--Ca, Pb--Pb, Th--Pb,
Rb--Sr, Sm--Nd, Re--Os, Lu--Hf, U--Th--He or Th--U data as X--Y
scatterplots, fits an isochron curve through them using the
\texttt{york}, \texttt{titterington} or \texttt{ludwig} function, and
computes the corresponding isochron age, including decay constant
uncertainties.\\

\texttt{kde} & Creates one or more kernel density estimates using a
combination of the \citet{botev2010} bandwidth selector and the
\citet{abramson1982} adaptive kernel bandwidth modifier.\\

\texttt{ludwig} & Implements the maximum likelihood algorithm for
Total-Pb/U isochron regression of \citet{ludwig1998} and extends the
underlying methodology to accommodate U--Th--Pb data
\citep{vermeesch2021} and initial U-series disequilibrium
\citep{mclean2016b}.\\

\texttt{mclean} & Returns the predicted ${206}$Pb/$^{238}$U and
$^{207}$Pb/$^{235}$U ratios for any given time with or without initial
U-series disequilibrium, using the matrix exponential approach of
\citet{mclean2016b}, which is summarised in
Section~\ref{sec:U-Pb-disequilibrium}. \\

\texttt{mds} & Performs classical or nonmetric Multidimensional
scaling analysis of detrital datasets using the Kolmogorov-Smirnov
statistic as a dissimilarity measure \citep{vermeesch2013}.\\

\texttt{Pb0corr} & Applies a common-Pb correction to U--Pb datasets
using either the Stacey-Kramers mantle evolution model, isochron
regression, or any nominal inital Pb isotope composition.\\

\texttt{peakfit} & Implements the discrete mixture modelling
algorithms of \citet{galbraith1993} and applies them to fission track
and other geochronological datasets.\\

\texttt{radialplot} & Visualise heteroscedastic datasets on
\citet{galbraith1988}'s radial plot, using one of the transformations
introduced in Sections~\ref{sec:radial} and \ref{sec:EDM}.\\

\texttt{read.data} & Cast a \texttt{.csv} file or a matrix into one of
the data classes that are documented under \texttt{classes}.\\

\texttt{scatterplot} & Takes bivariate data with (correlated)
uncertainties as input and produces a scatter plot with error ellipses
or crosses as output.  (optionally) displays the linear fit on this
diagram, and can show a third variable as a colour scale.\\

\texttt{set.zeta} & Determines the \textzeta-calibration constant of a
fission track dataset (EDM or LA-ICP-MS) given its true age and
analytical uncertainty.\\

\texttt{settings} & Get and set preferred values for decay constants,
isotopic abundances, molar masses, fission track etch efficiences, and
etchable lengths, and mineral densities, either individually or via a
\texttt{.json} file format.\\

\texttt{titterington} & Implements the maximum likelihood algorithm of
\citet{ludwig1994} for linear regression of three dimensional data
with correlated uncertainties.\\

\texttt{weightedmean} & Models the data as a normal distribution with
two sources of variance.  Estimates the mean and `overdispersion'
using the method of maximum likelihood. Computes the MSWD of a normal
fit without overdispersion. Implements a modified Chauvenet criterion
to detect and reject outliers. Only propagates the analytical
uncertainty associated with decay constants and \textzeta- and
J-factors after computing the weighted mean isotopic composition. \\

\texttt{york} & Implements the unified regression algorithm of
\citet{york2004} which, although based on least squares, yields
results that are consistent with maximum likelihood estimates of
\citet{titterington1979}.

\end{longtable}

\section{\texttt{json} schema}\label{sec:schema}

All the data and settings that are used by the GUI can be saved in a
human-readable text file, using the \texttt{.json} database format.
This format provides a useful method to archive \texttt{IsoplotR} data
for those users who do not want to use the CLI. The \texttt{.json}
format can also be used as a data exchange mechanism between
\texttt{IsoplotR} and other data processing software. If this software
produces a file that follows the following schema, then its output can
be used as input to \texttt{IsoplotR} for further processing.  The
\texttt{.json} format has a nested structure, which is summerised
below from the top downwards. At the highest level, the \texttt{.json}
data structure consists of four branches:

\begin{enumerate}
\item{\tt "constants"}: Lists the decay constants, isotopic ratios,
  molar masses, and various fission track properties.
\item{\tt "settings"}: Contains \texttt{IsoplotR}'s language
  settings and parameters controlling the behaviour of the various
  geochronometers and plot devices.
\item{\tt "data"}: Stores the contents of the GUI's input window,
  i.e. all the isotopic ratio data and calibration constants.
\item{\tt "optionschanged"}: This is a logical flag that is used
  internally to check whether \texttt{IsoplotR} should update the
  settings when the \texttt{PLOT}, \texttt{RUN}, \texttt{PDF} or
  \texttt{CSV} button is clicked.
\end{enumerate}

\noindent\texttt{"constants"} contains of the following items:

\begin{enumerate}[leftmargin=\parindent,align=left,
      labelwidth=\parindent,label*=1.\arabic*.]
\item{\tt "lambda"}: A comma-separated lists of two-element vectors
  containing the decay constants and their standard errors of
  \sloppy{\texttt{"U238"}, \texttt{"U235"}, \texttt{"U234"},
    \texttt{"Th232"}, \texttt{"Th230"}, \texttt{"Pa231"},
    \texttt{"Ra226"}, \texttt{"Rb87"}, \texttt{"Re187"},
    \texttt{"Sm147"}, \texttt{"K40"}, \texttt{"Lu176"} and spontaneous
    \textsuperscript{238}U \texttt{"fission"}}.
\item{\tt "iratio"}: A comma-separated lists of two-element vectors
  containing the natural isotopic ratios and their standard errors of
  \sloppy{\texttt{"Ar40Ar36"}, \texttt{"Ar38Ar36"},
    \texttt{"Ca40Ca44"}, \texttt{"Rb85Rb87"}, \texttt{""Sr84Sr86"},
    \texttt{"Sr87Sr86"}, \texttt{"Sr88Sr86"}, \texttt{"Re185Re187"},
    \texttt{"Os184Os192"}, \texttt{"Os186Os192"},
    \texttt{"Os187Os192"}, \texttt{"Os188Os192"},
    \texttt{"Os189Os192"}, \texttt{"Os190Os192"},
    \texttt{"Th230Th232"}, \texttt{"U234U238"}, \texttt{"U238U235"},
    \texttt{"Pb206Pb204"}, \texttt{"Pb207Pb204"},
    \texttt{"Pb207Pb206"}, \texttt{"Pb208Pb204"},
    \texttt{"Pb208Pb206"}, \texttt{"Pb208Pb207"},
    \texttt{"Sm144Sm152"}, \texttt{"Sm147Sm152"},
    \texttt{"Sm148Sm152"}, \texttt{"Sm149Sm152"},
    \texttt{"Sm150Sm152"}, \texttt{"Sm154Sm152"},
    \texttt{"Nd142Nd144"}, \texttt{"Nd143Nd144"},
    \texttt{"Nd145Nd144"}, \texttt{"Nd146Nd144"},
    \texttt{"Nd148Nd144"}, \texttt{"Nd150Nd144"},
    \texttt{"Lu176Lu175"}, \texttt{"Hf174Hf177"},
    \texttt{"Hf176Hf177"}, \texttt{"Hf178Hf177"},
    \texttt{"Hf179Hf177"} and \texttt{"Hf180Hf177"}.}
\item{\tt "imass"}: A comma-separated lists of two-element vectors
  containing the molar masses and their standard errors of \sloppy{
    \texttt{"U"}, \texttt{"Rb"}, \texttt{"Rb85"}, \texttt{"Rb87"},
    \texttt{"Sr"}, \texttt{"Sr84"}, \texttt{"Sr86"}, \texttt{"Sr87"},
    \texttt{"Sr88"}, \texttt{"Re"}, \texttt{"Re185"},
    \texttt{"Re187"}, \texttt{"Os"}, \texttt{"Os184"},
    \texttt{"Os186"},\texttt{"Os187"}, \texttt{"Os188"},
    \texttt{"Os189"}, \texttt{"Os190"}, \texttt{"Os192"},
    \texttt{"Sm"}, \texttt{"Nd"}, \texttt{"Lu"} and \texttt{"Hf"}.}
\item{\tt "etchfact"}: a two-element comma-separated list of fission
  track etch efficiency factors for \texttt{"apatite"} and
  \texttt{"zircon"}.
\item{\tt "tracklength"}: a two-element comma-separated list with the
  etchable range (in \textmu{m}) of fission tracks in
  \texttt{"apatite"} and \texttt{"zircon"}.
\item{\tt "mindens"}: a two-element comma-separated list with the
  density (in g/cm\textsuperscript{3}) of \texttt{"apatite"} and
  \texttt{"zircon"}.
\end{enumerate}

\noindent The \texttt{"settings"} branch of the top level
\texttt{json} object contains the following attributes:

\begin{enumerate}[leftmargin=\parindent,align=left,
      labelwidth=\parindent,label*=2.\arabic*.]
\item{\tt "language"}: one of \texttt{"en"} (English), \texttt{"es"}
  (Spanish) or \texttt{"zh"} (Mandarin Chinese). TODO
\item{\tt "geochronometer"}: one of \sloppy{\texttt{"fissiontracks"},
  \texttt{"detritals"}, \texttt{"U-Pb"}, \texttt{"Th-U"},
  \texttt{"Pb-Pb"}, \texttt{"Ar-Ar"}, \texttt{"Th-Pb"},
  \texttt{"Rb-Sr"}, \texttt{"Sm-Nd"}, \texttt{"Re-Os"},
  \texttt{"Lu-Hf"}, \texttt{"U-Th-He"} or \texttt{"other"}}.
\item{\tt "plotdevice"}: one of \sloppy{\texttt{"concordia"},
  \texttt{"evolution"}, \texttt{"isochron"}, \texttt{"regression"},
  \texttt{"radial"}, \texttt{"average"}, \texttt{"spectrum"},
  \texttt{"KDE"}, \texttt{"CAD"}, \texttt{"set-zeta"}, \texttt{"MDS"},
  \texttt{"helioplot"} or \texttt{"ages"}}.
\item{\tt "ierr"}: a number from 1 to 4, corresponding to the
  eponymous input argument of the \texttt{read.data()} function.
\item{\tt "par"}: \texttt{json} object with global settings to be
  passed on to \texttt{R}'s \texttt{par()} function. May, for example,
  contain \texttt{\{"cex": 1\}}.
\item{\tt "fissiontracks"}: a \texttt{json} object with the following
  attributes:
  \begin{enumerate}[leftmargin=0,align=left,labelwidth=\parindent,label*=\arabic*.]
  \item{\tt format}: a number from 1 to 3.
  \item{\tt mineral}: either \texttt{"apatite"} or \texttt{"zircon"}.
  \end{enumerate}
\item{\tt "detritals"}: a \texttt{json} object with the following
  attributes:
\item{\tt "U-Pb"}: a \texttt{json} object with the following
  attributes:
  \begin{enumerate}[leftmargin=0,align=left,labelwidth=\parindent,label*=\arabic*.]
  \item{\tt format}: a number from 1 to 8, corresponding to the
    eponymous argument of the \texttt{read.data()} function.
  \item{\tt type}: a number from 1 to 6, corresponding to the
    eponymous argument of the \texttt{age()}, \texttt{radialplot()},
    \texttt{weightedmean()}, \texttt{kde()} and \texttt{cad()}
    functions.
  \item{\tt cutoff76}: stores the value for the eponymous argument of
    the \texttt{age()}, \texttt{radialplot()},
    \texttt{weightedmean()}, \texttt{kde()} and \texttt{cad()}
    functions.
  \item{\tt cutoffdisc}: either 0 (no discordance filter), 1
    (discordance filter to be used before common Pb correction), or 2
    (discordance filter to be used after common Pb correction).
  \item{\tt discoption}: a number from 0 to 5, storing the value to be
    passed on to the \texttt{option} argument of the
    \texttt{discfilter} function.
  \item{\tt mindisc}: a 5-element vector of minimum discordance cutoff
    values (one for each of \texttt{discoption}'s values 1 through 5),
    to be used in \texttt{discfilter()}'s \texttt{cutoff} argument.
  \item{\tt maxdisc}: a 5-element vector of maximum discordance cutoff
    values (one for each of \texttt{discoption}'s values 1 through 5),
    to be used in \texttt{discfilter()}'s \texttt{cutoff} argument.
  \end{enumerate}
\item{\tt "Th-U"}: a \texttt{json} object with the following
  attributes:
  \begin{enumerate}
    \item{\tt} 
  \end{enumerate}
\item{\tt "Pb-Pb"}:
\item{\tt "Ar-Ar"}:
\item{\tt "Th-Pb"}:
\item{\tt "Rb-Sr"}:
\item{\tt "Sm-Nd"}:
\item{\tt "Re-Os"}:
\item{\tt "Lu-Hf"}:
\item{\tt "U-Th-He"}:
\item{\tt "other"}:
\item{\tt "concordia"}:
\item{\tt "evolution"}:
\item{\tt "isochron"}:
\item{\tt "regression"}:
\item{\tt "radial"}:
\item{\tt "average"}:
\item{\tt "spectrum"}:
\item{\tt "KDE"}:
\item{\tt "CAD"}:
\item{\tt "set-zeta"}:
\item{\tt "MDS"}:
\item{\tt "helioplot"}:
\item{\tt "ages"}:
\end{enumerate}

\begin{enumerate}[leftmargin=\parindent,align=left,
      labelwidth=\parindent,label*=3.\arabic*.]
\item{\tt "fissiontracks"}:
\item{\tt "detritals"}:
\item{\tt "U-Pb"}:
\item{\tt "Th-U"}:
\item{\tt "Pb-Pb"}:
\item{\tt "Ar-Ar"}:
\item{\tt "Th-Pb"}:
\item{\tt "Rb-Sr"}:
\item{\tt "Sm-Nd"}:
\item{\tt "Re-Os"}:
\item{\tt "Lu-Hf"}:
\item{\tt "U-Th-He"}:
\item{\tt "other"}:
\end{enumerate}

\printbibliography[heading=subbibliography]

\end{refsection}
